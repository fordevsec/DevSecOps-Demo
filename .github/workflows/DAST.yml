name: "DAST-workflow"

on: #workflowを実行する条件を指定
  # push:  
    # branches: [ "feature/**"] #指定したブランチにプッシュした場合に実行

  pull_request:
    branches: [ "main" ]

jobs:
  DAST-Job:
    runs-on: ubuntu-latest
    # if: github.actor != 'dependabot[bot]'
    # strategy: 
    #   matrix: # 変数を設定
    #     python-version: [ "3.11" ]
    #     architecture: [ "x64" ]
    # permissions:
    #   checks: write
    #   pull-requests: write
    #   issues: write

    steps:

      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Python ${{ matrix.python-version }} # ランタイムをセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: ${{ matrix.architecture }}
      
      - name: Install dependencies # テストを実行するために依存関係のインストール
        run: pip install -r requirements.txt 

      - name: Run localhost server 
        run: python src/manage.py runserver &

      - uses: actions/checkout@v2
        with:
        ref: main
      - name: Building Docker
        run: docker-compose build
      - name: Launching the app
        run: docker-compose up --detach

      - name: ZAP Full Scan 
        uses: zaproxy/action-full-scan@v0.9.0
        with:
          # docker_name: "owasp/zap2docker-stable" 安定版でスキャンする場合は指定必要なし
          target: "http://localhost:8000/sample_app/post/"
          fail_action: false
          token: ${{ secrets.GITHUB_TOKEN }}
          issue_title: Security Tests
          artifact_name: DAST-Scan-Report
